<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AR Hand Particle System v2</title>
<style>
body { margin:0; overflow:hidden; background:black; }
video { display:none; }
</style>
</head>
<body>

<video id="video" autoplay></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* SCENE */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 90;

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* BLOOM */
const composer = new THREE.EffectComposer(renderer);
composer.addPass(new THREE.RenderPass(scene, camera));
const bloom = new THREE.UnrealBloomPass(
  new THREE.Vector2(innerWidth, innerHeight),
  1.5, 0.4, 0.85
);
composer.addPass(bloom);

/* PARTICLES */
const COUNT = 4000;
const geo = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT * 3);
let mode = 0;

function createParticles() {
  for (let i=0;i<COUNT;i++) {
    let a = Math.random()*Math.PI*2;
    let r = 25;

    if (mode===0) { // HEART
      r = 16*Math.pow(Math.sin(a),3);
      pos[i*3] = r*Math.cos(a);
      pos[i*3+1] = 13*Math.cos(a)-5*Math.cos(2*a);
      pos[i*3+2] = (Math.random()-0.5)*10;
    }
    if (mode===1) { // SATURN
      pos[i*3] = r*Math.cos(a);
      pos[i*3+1] = (Math.random()-0.5)*4;
      pos[i*3+2] = r*Math.sin(a);
    }
    if (mode===2) { // FIREWORK
      pos[i*3]=(Math.random()-0.5)*50;
      pos[i*3+1]=(Math.random()-0.5)*50;
      pos[i*3+2]=(Math.random()-0.5)*50;
    }
  }
  geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
}
createParticles();

const mat = new THREE.PointsMaterial({
  size:1.8,
  color:0xff44ff,
  transparent:true
});

const pts = new THREE.Points(geo, mat);
scene.add(pts);

/* HAND TRACKING */
const hands = new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks) return;

  const h=r.multiHandLandmarks[0];
  const d=Math.hypot(h[8].x-h[4].x,h[8].y-h[4].y);

  // EXPAND
  pts.scale.setScalar(1+d*4);

  // COLOR
  mat.color.setHSL(d*3,1,0.6);

  // PINCH = FIREWORK
  if(d<0.04){
    mode=2; createParticles();
  }

  // OPEN HAND = SHAPE CHANGE
  if(d>0.2){
    mode=(mode+1)%3;
    createParticles();
  }
});

/* CAMERA */
const cam=new Camera(document.getElementById('video'),{
  onFrame:async()=>hands.send({image:video}),
  width:640,height:480
});
cam.start();

/* LOOP */
function animate(){
  requestAnimationFrame(animate);
  pts.rotation.y+=0.003;
  composer.render();
}
animate();
</script>
</body>
</html>
